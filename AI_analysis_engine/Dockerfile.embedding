FROM python:3.9-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    poppler-utils \
    tesseract-ocr \
    libgl1-mesa-glx \
    libglib2.0-0 \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python packages
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application files
COPY main.py embedding_llm.py enhanced_detection.py ocr_processor.py ./
COPY advanced_plagiarism_algorithms.py ./

# Create directories
RUN mkdir -p data result

# Environment variables
ENV TRANSFORMERS_OFFLINE=1
ENV HF_HUB_OFFLINE=1
ENV PYTHONUNBUFFERED=1

# Download models at build time
RUN python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('all-MiniLM-L6-v2'); SentenceTransformer('BAAI/bge-small-en')"

CMD ["python", "main.py", "--file", "data/assignment.pdf", "--subject", "Computer Science", "--id", "test123"]